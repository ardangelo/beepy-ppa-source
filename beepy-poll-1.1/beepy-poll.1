.\" Automatically generated by Pandoc 2.17.1.1
.\"
.\" Define V font for inline verbatim, using C font in formats
.\" that render this, and otherwise B font.
.ie "\f[CB]x\f[]"x" \{\
. ftr V B
. ftr VI BI
. ftr VB B
. ftr VBI BI
.\}
.el \{\
. ftr V CR
. ftr VI CI
. ftr VB CB
. ftr VBI CBI
.\}
.TH "Beepy Polling Service" "" "" "" ""
.hy
.SH Beepy Poll
.SS User Guide
.PP
The \f[V]beepy-poll\f[R] package installs a boot-time polling utility
\f[V]beepy-poll\f[R], as well as an idler service \f[V]beepy-idle\f[R].
.SS \f[V]beepy-poll\f[R]
.PP
Running \f[V]beepy-poll\f[R] with no arguments will shut down the Pi,
and schedule the Pi to boot back up in 15 minutes.
.PP
If woken back up on this timer, the service will wait for network
access, then run all scripts in the directory
\f[V]\[ti]/.config/beepy-poll.d/\f[R].
When all the scripts have completed, it will shut down again and wait
for another 15 minutes.
.IP
.nf
\f[C]
Poll as USER. Press any key to interrupt...
Mon Jan 01 12:00:00 CDT 2024
Waiting for network...
Waiting for NetworkManager... (1/5)
Waiting for network connection... (1/5)
Running \[ti]/.config/beepy-poll.d/50-gomuks
    (Gomuks poller output)
\f[R]
.fi
.PP
If no network connection is found, then the poller will not run the
scripts, and schedule another rewake in 15 minutes.
.IP
.nf
\f[C]
Waiting for network...
Network not found, repoll in 15 min.
\f[R]
.fi
.PP
Pressing any key during the poll will cancel the poll and continue with
a full boot process.
.SS \f[V]50-gomuks\f[R] Gomuks polling script
.PP
The \f[V]beepy-poll\f[R] package provides a script \f[V]50-gomuks\f[R]
that will run the Gomuks messenger in headless poll mode using
\f[V]gomuks --headless\f[R].
Any new messages will cause the notification LED to flash until a key is
pressed.
.PP
It is installed to \f[V]/etc/skel/.config/beepy-poll.d/50-gomuks\f[R].
The default Beepy Raspbian install has already run this step for the
first user, and you can find your user\[cq]s copy at
\f[V]\[ti]/.config/beepy-poll.d/50-gomuks\f[R].
.SS \f[V]beepy-poll install\f[R]
.PP
This will copy all default poller scripts from
\f[V]/etc/skel/.config/beepy-poll.d/\f[R] to
\f[V]\[ti]/.config/beepy-poll.d/\f[R].
Then, it will run each script with the argument \f[V]install\f[R].
.PP
The default Beepy Raspbian install has already run this step for the
first user, and you can find the default Gomuks poller script at
\f[V]\[ti]/.config/beepy-poll.d/50-gomuks\f[R].
.SS Adding new scripts
.PP
The \f[V]beepy-poll\f[R] package provides the Gomuks poller script
\[ga]\f[V]/etc/skel/.config/beepy-poll.d/50-gomuks\f[R] On the default
Beepy Raspbian configuration, it is also installed to the default user
account at \f[V]\[ti]/.config/beepy-poll.d/50-gomuks\f[R].
.PP
You can reference it to create other polling scripts.
It uses \f[V]screen\f[R] to create a virtual sized TTY, as Gomuks
requires starting its text-based graphical interface.
For a simple terminal polling script, you do not need to use
\f[V]screen\f[R], and can send output to standard out.
.IP
.nf
\f[C]
#!/bin/bash

if [ \[dq]$1\[dq] == \[dq]install\[dq] ]; then
    SCRIPTPATH=\[dq]$( cd -- \[dq]$(dirname \[dq]$0\[dq])\[dq] >/dev/null 2>&1 ; dirs +0 )\[dq]
    echo \[dq]Polling script ran from\[dq]
    echo \[dq]    $SCRIPTPATH/$(basename $0)\[dq]
    exit 0
fi

/run/your/command/here
\f[R]
.fi
.SS \f[V]beepy-idle\f[R]
.PP
On first setup of Beepy Raspbian, you will be presented with an option
to either enable or disable the \f[V]beepy-idle\f[R] service.
If enabled, this service will automatically shut down the Pi and deep
sleep the RP2040 controller to preserve battery life.
.PP
The Pi will not shut down unless it has been a configurable amount of
minutes since the last keypress, or if Tmux is running an active
foreground process.
.PP
The timeout and allowed processes can be configured by editing the file
at \f[V]/etc/beepy-idle.conf\f[R].
By default, if Tmux is running any process other than \f[V]bash\f[R] or
\f[V]gomuks\f[R], idle will be inhibited.
.IP
.nf
\f[C]
# Automatic idle shutdown time in minutes
# since last keypress. Change to 0 to disable
IDLE_TIME=5

# Allow automatic shutdown if the following processes
# are running in tmux, otherwise deny
ALLOW_PROCS=\[dq]bash gomuks\[dq]
\f[R]
.fi
.PP
To disable \f[V]beepy-idle\f[R], stop the idle service and idle timer:
.IP
.nf
\f[C]
sudo systemctl disable beepy-idle.service
sudo systemctl disable beepy-idle.timer
\f[R]
.fi
.PP
To enable \f[V]beepy-idle\f[R], enable and start the idle timer:
.IP
.nf
\f[C]
sudo systemctl enable beepy-idle.timer
sudo systemctl start beepy-idle.timer
\f[R]
.fi
.SS Developer Reference
.PP
The \f[V]beepy-kbd\f[R] keyboard driver provides several sysfs entries.
The \f[V]rewake_timer\f[R] entry, when written, shuts down the Pi, and
boots it back up in that many minutes.
After booting back up using \f[V]rewake_timer\f[R], the
\f[V]startup_reason\f[R] sysfs entry will contain the text
\f[V]rewake\f[R].
.PP
The \f[V]beepy-poll\f[R] utility will set and check these sysfs entries
to determine if the system was woken up as part of a \f[V]rewake\f[R]
timer.
If so, it will run the poller scripts and then schedule another rewake.
