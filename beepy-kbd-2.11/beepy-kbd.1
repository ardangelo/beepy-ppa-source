.\" Automatically generated by Pandoc 2.17.1.1
.\"
.\" Define V font for inline verbatim, using C font in formats
.\" that render this, and otherwise B font.
.ie "\f[CB]x\f[]"x" \{\
. ftr V B
. ftr VI BI
. ftr VB B
. ftr VBI BI
.\}
.el \{\
. ftr V CR
. ftr VI CI
. ftr VB CB
. ftr VBI CBI
.\}
.TH "Beepy Keyboard Driver" "" "" "" ""
.hy
.SH Beepy Keyboard Driver
.IP \[bu] 2
User Guide
.RS 2
.IP \[bu] 2
Indicators
.IP \[bu] 2
Basic key mappings
.IP \[bu] 2
Sticky modifier keys
.IP \[bu] 2
Meta mode
.IP \[bu] 2
Touchpad mode
.IP \[bu] 2
\f[V]sysfs\f[R] interface
.IP \[bu] 2
Module parameters
.IP \[bu] 2
Custom keymap
.RE
.IP \[bu] 2
Developer Reference
.RS 2
.IP \[bu] 2
Building from source
.IP \[bu] 2
Direct write firmware updates
.RE
.SS User Guide
.PP
The Beepy keyboard driver, \f[V]beepy-kbd\f[R], controls interaction
between the RP2040 firmware \f[V]beepy-fw\f[R] and Linux running on the
Raspberry Pi.
It has several responsibilities, including
.IP \[bu] 2
Communicating keyboard and touchpad input to Linux
.IP \[bu] 2
Power and standby management
.IP \[bu] 2
Synchronizing the real-time clock
.IP \[bu] 2
Firmware update management
.SS Indicators
.PP
Due to the limited number of keys, there are different shortcuts and
modes mapped by the keyboard driver.
You will see different types of indicators in the top right corner of
the screen depending on the mode:
.IP \[bu] 2
[IMAGE: Shift indicator] Shift modifier
.IP \[bu] 2
[IMAGE: Phys.
Alt indicator] Physical Alt modifier
.IP \[bu] 2
[IMAGE: Control indicator] Control modifier
.IP \[bu] 2
[IMAGE: Alt indicator] Alt modifier
.IP \[bu] 2
[IMAGE: Symbol mode indicator] Symbol mode modifier
.IP \[bu] 2
[IMAGE: Meta mode indicator] Meta mode modifier
.IP \[bu] 2
[IMAGE: Touch mode indicator] Touchpad mode modifier
.SS Basic key mappings
.PP
From left to right, the top row of the Beepy keyboard has the following
keys:
.IP \[bu] 2
\[lq]Call\[rq], a phone facing up.
.RS 2
.IP \[bu] 2
Single click: Enter Control key (sticky modifier).
.IP \[bu] 2
Short hold: Lock Control key (sticky modifier).
.RE
.IP \[bu] 2
\[lq]Berry\[rq]: a collection of sections shaped like a fruit.
.RS 2
.IP \[bu] 2
Single click: Enter Meta mode.
.IP \[bu] 2
Short hold (1s): Display Meta mode reference overlay.
.RE
.IP \[bu] 2
\[lq]Touchpad\[rq]: pressing the touchpad sensor will click and produce
a key event.
.RS 2
.IP \[bu] 2
Single click: by default, enable touchpad mode, sending arrow keys.
If touchpad mode is already on, a single click will send
\f[V]Enter\f[R].
.RE
.IP \[bu] 2
\[lq]Back\[rq]: an arrow looping back onto itself.
.RS 2
.IP \[bu] 2
Single click: send \f[V]Escape\f[R].
Commonly used to exit menus in utilities.
.RE
.IP \[bu] 2
\[lq]End Call\[rq]: a phone facing down, with a line underneath.
.RS 2
.IP \[bu] 2
Single click: Send the tmux prefix.
Prefix is configurable in the driver keymap.
.IP \[bu] 2
Short hold (1s): Open the tmux menu.
If the Pi has been shut down, a short hold will turn the Pi back on.
.IP \[bu] 2
Long hold (5s): send a shutdown signal to the Pi.
.RE
.PP
The alternate symbols printed directly on the keys are sent by pressing
the \f[V]Physical Alt\f[R] key on the bottom left corner of the
keyboard, then pressing the key on which the desired symbol is printed.
While \f[V]Physical Alt\f[R] is active, you will see an \f[V]a\f[R]
indicator in the top right corner of the screen: [IMAGE: Physical Alt
indicator].
The combination \f[V]Physical Alt\f[R] + \f[V]Enter\f[R] is also mapped
to \f[V]Tab\f[R].
\f[V]Physical Alt\f[R] is a \[lq]sticky modifier key\[rq].
.PP
For additional symbols not printed directly on the keys, use the
\f[V]Symbol\f[R] key on the bottom row of the keyboard.
While \f[V]Symbol\f[R] is active, you will see an \f[V]S\f[R] indicator
in the top right of the screen: [IMAGE: Symbol indicator].
Internally, \f[V]Symbol\f[R] sends AltGr (Right Alt), which is mapped to
more symbols via the keymap file at
\f[V]/usr/share/kbd/keymaps/beepy-kbd.map\f[R].
\f[V]Symbol\f[R] is a \[lq]sticky modifier key\[rq].
You can view the Symbol key map by holding the \f[V]Symbol\f[R] key for
1 second.
Modifying the keymap file will also update the Symbol key map displayed;
below is the default key map:
.PP
[IMAGE: Default Symbol key map]
.PP
Arrow keys and other movement keys such as Page Up and Page Down are
accessible in Meta mode.
.SS Sticky modifier keys
.PP
For easier typing, the keyboard driver implements sticky modifier keys.
Pressing and releasing a modifier applies the modifier to the next alpha
keypress only.
If the same modifier key is pressed and released again, it will be
canceled.
.PP
Holding a modifier key while typing an alpha key will apply the modifier
to all alpha keys until the modifier is released.
.PP
While a modifier key is active, visual indicators are drawn in the top
right corner of the display, with indicators for [IMAGE: Shift
indicator] Shift, [IMAGE: Physical Alt indicator] Physical Alt,
[IMAGE: Control indicator] Control, [IMAGE: Alt indicator] Alt,
[IMAGE: Symbol mode indicator] Symbol, [IMAGE: Meta mode indicator] Meta
mode, and [IMAGE: Touch mode indicator] Touchpad mode.
.PP
For example, to type a dot \f[V].\f[R], you can use
\f[V]Physical Alt\f[R] sticky mode:
.IP \[bu] 2
Press and release the \f[V]Physical Alt\f[R] key
.IP \[bu] 2
The \f[V]a\f[R] indicator [IMAGE: Physical Alt indicator] appears,
showing that \f[V]Physical Alt\f[R] mode will be applied to the next
keypress only
.IP \[bu] 2
Type the \f[V]M\f[R] key to input a dot \f[V].\f[R]
.IP \[bu] 2
The \f[V]a\f[R] indicator disappears
.PP
Alternatively, to type a dot \f[V].\f[R] followed by a comma
\f[V],\f[R], you can also press and hold \f[V]Physical Alt\f[R]:
.IP \[bu] 2
Press the \f[V]Physical Alt\f[R] key
.IP \[bu] 2
The \f[V]a\f[R] indicator [IMAGE: Physical Alt indicator] appears,
showing that \f[V]Physical Alt\f[R] mode is active
.IP \[bu] 2
While holding \f[V]Physical Alt\f[R], type the \f[V]M\f[R] key to input
a dot \f[V].\f[R]
.IP \[bu] 2
While holding \f[V]Physical Alt\f[R], type the \f[V]N\f[R] key to input
a comma \f[V],\f[R]
.IP \[bu] 2
Release the \f[V]Physical Alt\f[R] key
.IP \[bu] 2
The \f[V]a\f[R] indicator disappears
.SS Meta mode
.PP
Meta mode is a modal layer that assists in rapidly moving the cursor and
scrolling with single keypresses.
To enter Meta mode, click the \f[V]Berry\f[R] key once.
The Meta mode indicator [IMAGE: Meta mode indicator] will appear in the
top right corner of the screen, and the following keymap will be applied
until Meta mode is dismissed using the \f[V]Back\f[R] key, or otherwise
noted:
.IP \[bu] 2
\f[V]E\f[R] Up \f[V]S\f[R] Down \f[V]W\f[R] Left \f[V]D\f[R] Right
.RS 2
.IP \[bu] 2
Why not \f[V]WASD\f[R]?
This way, you can place your thumb in the middle of all four of these
keys, and fluidly move the cursor without mistyping on e.g.\ \f[V]Q\f[R]
or \f[V]E\f[R]
.RE
.IP \[bu] 2
\f[V]R\f[R] Home \f[V]F\f[R] End \f[V]O\f[R] Page Up \f[V]P\f[R] Page
Down
.IP \[bu] 2
\f[V]Q\f[R] Back one word (\f[V]Alt + Left\f[R]) \f[V]A\f[R] Forward one
word (\f[V]Alt + Right\f[R])
.IP \[bu] 2
\f[V]T\f[R] Tab (dismisses Meta mode)
.IP \[bu] 2
\f[V]X\f[R] Apply \f[V]Control\f[R] to next key (dismisses Meta mode)
.IP \[bu] 2
\f[V]C\f[R] Apply \f[V]Alt\f[R] to next key (dismisses Meta mode)
.IP \[bu] 2
\f[V]0\f[R] Toggle display inversion from white-on-black to
black-on-white
.IP \[bu] 2
\f[V]N\f[R] Decrease keyboard brightness
.IP \[bu] 2
\f[V]M\f[R] Increase keyboard brightness
.IP \[bu] 2
\f[V]$\f[R] Toggle keyboard backlight
.IP \[bu] 2
\f[V]Back\f[R] Exit Meta mode
.PP
Typing any other key while in Meta mode will exit Meta mode and send the
key as if it was typed normally.
.PP
You can view the Meta mode key map by holding the \f[V]Berry\f[R] key
for 1 second:
.PP
[IMAGE: Meta mode key map]
.SS Touchpad mode
.PP
The Beepy touchpad is not actually touch sensitive, rather it is an
optical trackpad.
This has the downside of sending touchpad input if material other than a
finger moves across it, such as a pocket.
To reduce false positives, the default mode of the Beepy touchpad is to
remain off until a key is used to turn it on.
Touchpad behavior, including mouse and activation, can be configured via
module parameters.
.PP
Press the touchpad itself to turn on touchpad mode, and start sending
arrow keys when you move your finger across the touchpad.
While active, you will see the touchpad indicator [IMAGE: Touchpad
indicator] in the top-right corner of the screen.
.PP
Clicking the touchpad itself again while the touchpad is active will
send \f[V]Enter\f[R].
Pressing the \f[V]Back\f[R] key will exit touchpad mode.
.PP
You can also hold the \f[V]Shift\f[R] key to temporarily turn on the
touchpad until the \f[V]Shift\f[R] key is released.
You will see the Shift indicator [IMAGE: Shift indicator] instead of the
touch indicator.
.PP
If you release the \f[V]Shift\f[R] key \f[I]without\f[R] using the
touchpad, you will instead get the sticky modifier behavior of applying
Shift to the next alpha keypress.
In this case, the [IMAGE: Shift indicator] will remain on the screen.
Press and release the \f[V]Shift\f[R] key again to un-stick the modifier
and hide the indicator.
.SS \f[V]sysfs\f[R] interface
.PP
The keyboard driver creates several sysfs entries under
\f[V]/sys/firmware/beepy\f[R] to expose different parts of the firmware.
These entries can be manipulated like a normal file using traditional
Unix tools such as \f[V]cat\f[R] and \f[V]tee\f[R], and in shell
scripts.
.IP \[bu] 2
\f[V]battery_raw\f[R] Raw ADC output value for the battery level.
Read-only.
.IP \[bu] 2
\f[V]battery_volts\f[R] Approximate battery voltage.
Read-only.
.IP \[bu] 2
\f[V]battery_percent\f[R] Approximate battery percentage remaining.
Read-only.
.IP \[bu] 2
\f[V]led_red\f[R], \f[V]led_green\f[R], \f[V]led_blue\f[R] set LED color
intensity from 0 to 255.
Apply by writing to \f[V]led\f[R].
Write-only.
.IP \[bu] 2
\f[V]led\f[R]: Also applies color settings.
Write-only.
.RS 2
.IP \[bu] 2
\f[V]0\f[R] Turn off LED.
.IP \[bu] 2
\f[V]1\f[R] Turn on LED.
.IP \[bu] 2
\f[V]2\f[R] Flash LED.
.IP \[bu] 2
\f[V]3\f[R] Flash LED until key pressed.
Overlays on top of an existing LED setting.
For example, the following write sequence will set the LED to be solid
red, but with a blue flash.
Then, when a key is pressed, it will return to a solid red.
.RS 2
.IP
.nf
\f[C]
# Set LED to solid red
echo 255 | sudo tee /sys/firmware/beepy/led_red
echo   0 | sudo tee /sys/firmware/beepy/led_green
echo   0 | sudo tee /sys/firmware/beepy/led_blue
echo   1 | sudo tee /sys/firmware/beepy/led

# Set LED to flash blue until key pressed
echo   0 | sudo tee /sys/firmware/beepy/led_red
echo   0 | sudo tee /sys/firmware/beepy/led_green
echo 255 | sudo tee /sys/firmware/beepy/led_blue
echo   3 | sudo tee /sys/firmware/beepy/led
\f[R]
.fi
.RE
.RE
.IP \[bu] 2
\f[V]keyboard_backlight\f[R] Set keyboard brightness from 0 to 255.
Write-only.
The default brightness is low, but still on.
Setting the brightness to maximum will noticeably increase power draw.
.IP \[bu] 2
\f[V]rewake_timer\f[R] Write to shut down the Pi, then power-on in that
many minutes.
Write-only.
Useful for polling services in conjunction with
\f[V]startup_reason\f[R], such as with the beepy-poll service.
.IP \[bu] 2
\f[V]startup_reason\f[R] Contains the reason why the Pi was booted.
Useful for polling services in conjunction with \f[V]rewake_timer\f[R].
.RS 2
.IP \[bu] 2
\f[V]fw_init\f[R] RP2040 initialized and booted Pi.
.IP \[bu] 2
\f[V]power_button\f[R] Power button held to turn Pi back on.
.IP \[bu] 2
\f[V]rewake\f[R] Rewake triggered from \f[V]rewake_timer\f[R].
.IP \[bu] 2
\f[V]rewake_canceled\f[R] During rewake polling, 0 was written to
\f[V]rewake_timer\f[R].
This allows the \f[V]beepy-poll\f[R] service to cancel the poll and
proceeded with a full boot.
.RE
.IP \[bu] 2
\f[V]fw_version\f[R] Installed firmware version.
Read-only.
.IP \[bu] 2
\f[V]fw_update\f[R] Write to update firmware.
Read-write See Firmware updates.
.IP \[bu] 2
\f[V]last_keypress\f[R] Milliseconds since last keypress.
Read-only.
.SS Module parameters
.PP
Configure various aspects of the driver itself.
Write to \f[V]/sys/module/beepy_kbd/parameters/<param>\f[R] to set with
\f[V]echo <val> | sudo tee /sys/module/beepy_kbd/parameters/<param>\f[R].
Or unload and reload the module with
\f[V]sudo modprobe -r beepy-kbd; sudo modprobe beepy-kbd param=val\f[R].
.IP \[bu] 2
\f[V]touch_act\f[R] One of \f[V]click\f[R] or \f[V]always\f[R].
.RS 2
.IP \[bu] 2
\f[V]click\f[R] Default, will disable touchpad until the touchpad button
is clicked.
.IP \[bu] 2
\f[V]always\f[R] Touchpad always on, swiping sends touch input, clicking
sends \f[V]Enter\f[R].
.RE
.IP \[bu] 2
\f[V]touch_as\f[R]: one of \f[V]keys\f[R] or \f[V]mouse\f[R].
.RS 2
.IP \[bu] 2
\f[V]keys\f[R] Default, send arrow keys with the touchpad.
.IP \[bu] 2
\f[V]mouse\f[R] Send mouse input (useful for X11).
.RE
.IP \[bu] 2
\f[V]touch_shift\f[R] Default on.
Send touch input while the Shift key is held.
.IP \[bu] 2
\f[V]touch_min_squal\f[R] Reject touchpad input if surface quality as
reported by touchpad sensor is lower than this threshold.
Default \f[V]16\f[R].
.IP \[bu] 2
\f[V]touch_led_setting\f[R] One of \f[V]low\f[R], \f[V]med\f[R],
\f[V]high\f[R].
Touchpad LED power setting.
\f[V]high\f[R] is recommended for reliable input.
Default \f[V]high\f[R].
.IP \[bu] 2
\f[V]shutdown_grace\f[R] To avoid powering off the Pi while it is still
running, this is set to the number of seconds to wait between a shutdown
signal and the firmware removing power from the Pi.
This helps ensure that the Pi has time to process the power-off command
and to shut down cleanly.
Default \f[V]30\f[R] seconds.
.IP \[bu] 2
\f[V]auto_off\f[R] In most cases, the keyboard driver is loaded on boot
and unloaded during shutdown.
For substantial power savings, the default-enabled \f[V]auto_off\f[R]
setting will trigger when the driver is unloaded.
After a 30 second wait to allow for the driver to potentially be
reloaded, the Pi will shutdown, wait for \f[V]shutdown_grace\f[R]
seconds, then power off the Pi and enter deep sleep.
Default on.
.IP \[bu] 2
\f[V]sharp_path\f[R] Sharp DRM device to send overlay commands.
Default: \f[V]/dev/dri/card0\f[R].
.IP \[bu] 2
\f[V]sysfs_gid\f[R] Group ID of sysfs entries in
\f[V]/sys/firmware/beepy\f[R].
Set this to the result of \f[V]id -g\f[R] to allow access without
\f[V]sudo\f[R].
Beepy Raspbian configures the first user group by default.
.IP \[bu] 2
\f[V]handle_poweroff\f[R] Enable to have driver invoke
\f[V]/sbin/poweroff\f[R] when power key held.
not necessary for Beepy Raspbian, may be necessary if running a custom
build of the driver on another Linux distribution.
Default off.
.SS Custom keymap
.PP
The \f[V]Physical Alt\f[R] and \f[V]Symbol\f[R] keymaps and the Tmux
prefix sent by the \f[V]Berry\f[R] key can be edited in the file
\f[V]/usr/share/kbd/keymaps/beepy-kbd.map\f[R].
To reapply the keymap without rebooting, run
\f[V]loadkeys /usr/share/kbd/keymaps/beepy-kbd.map\f[R].
.PP
Holding the \f[V]Symbol\f[R] key to display the keymap will display the
keymap directly from this file.
.SS Developer Reference
.SS Building from source
.IP \[bu] 2
Install build prerequisites.
.RS 2
.PP
sudo apt-get install raspberrypi-kernel-headers
.RE
.IP \[bu] 2
Enable I2C Peripheral.
Run \f[V]sudo raspi-config\f[R], then under \f[V]Interface Options\f[R],
enable \f[V]I2C\f[R].
.IP \[bu] 2
Build, install, and enable the kernel module.
.RS 2
.PP
make sudo make install
.RE
.PP
To remove, run \f[V]sudo make uninstall\f[R], then verify that
\f[V]/etc/modules\f[R] and \f[V]/boot/firmware/config.txt\f[R] have
removed the driver lines.
.SS Direct write firmware updates
.PP
In most cases, you will use the \f[V]update-beepy-fw\f[R] utility to
update firmware from a firmware package or file.
However, you can also manually write firmware update data to the sysfs
entry at \f[V]/sys/firmware/beepy/fw_update\f[R].
.PP
RP2040 firmware is loaded in two stages.
The first stage is a modified version of
pico-flashloader (https://github.com/rhulme/pico-flashloader).
It allows updates to be flashed to the second stage firmware while
booted.
The second stage is the actual Beepy firmware.
.PP
Firmware updates are flashed by writing to
\f[V]/sys/firmware/beepy/fw_update\f[R]:
.IP \[bu] 2
Header line beginning with \f[V]+\f[R] e.g.\ \f[V]+Beepy\f[R]
.IP \[bu] 2
Followed by the contents of an image in Intel HEX format
.PP
Please wait until the system reboots on its own before removing power.
If the update failed, will contain an error code and the firmware will
not be modified.
.PP
The header line \f[V]+...\f[R] will reset the update process, so an
interrupted or failed update can be retried by restarting the firmware
write.
.PP
If the update completes successfully, the system will be rebooted.
There is a delay configurable at
\f[V]/sys/firmware/beepy/shutdown_grace\f[R] to allow the operating
system to cleanly shut down before the Pi is powered off.
The firmware is flashed right before the Pi boots back up, so please
wait until the system reboots on its own before removing power.
